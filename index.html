<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNA Admin - Bank Sulselbar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #0A4D8C;
            --primary-dark: #063A6A;
            --secondary: #D4A84B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --dark: #1A1A2E;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header img {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: white;
            padding: 5px;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-card .icon.blue { background: #EBF5FF; color: var(--info); }
        .stat-card .icon.green { background: #ECFDF5; color: var(--success); }
        .stat-card .icon.yellow { background: #FFFBEB; color: var(--warning); }
        .stat-card .icon.purple { background: #F3E8FF; color: #8B5CF6; }
        
        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stat-card p {
            color: var(--gray-500);
            font-size: 0.9rem;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Import Section */
        .import-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .import-tab {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .import-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .import-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .import-tab .badge {
            background: var(--gray-200);
            color: var(--gray-600);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        
        .import-tab.active .badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .drop-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--gray-100);
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background: #EBF5FF;
        }
        
        .drop-zone i {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }
        
        .drop-zone h4 {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }
        
        .drop-zone p {
            color: var(--gray-500);
            font-size: 0.9rem;
        }
        
        .file-info {
            display: none;
            background: #ECFDF5;
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .file-info.show {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .file-info i {
            font-size: 2rem;
            color: var(--success);
        }
        
        .file-info .details h5 {
            color: var(--dark);
            font-weight: 600;
        }
        
        .file-info .details p {
            color: var(--gray-500);
            font-size: 0.85rem;
        }
        
        /* Preview Table */
        .preview-section {
            display: none;
            margin-top: 1.5rem;
        }
        
        .preview-section.show {
            display: block;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .preview-header h4 {
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: var(--gray-100);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Progress */
        .progress-section {
            display: none;
            margin-top: 1.5rem;
        }
        
        .progress-section.show {
            display: block;
        }
        
        .progress-bar-container {
            background: var(--gray-200);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--primary), var(--info));
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .alert-info {
            background: #EBF5FF;
            color: var(--info);
            border: 1px solid var(--info);
        }
        
        .alert-success {
            background: #ECFDF5;
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .alert-danger {
            background: #FEF2F2;
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .pill-info { background: #EBF5FF; color: var(--info); }
        .pill-success { background: #ECFDF5; color: var(--success); }
        .pill-warning { background: #FFFBEB; color: var(--warning); }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }
        
        .toast {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Data Tables */
        .data-section {
            display: none;
        }
        
        .data-section.active {
            display: block;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0.5rem;
        }
        
        .nav-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-500);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: var(--gray-100);
            color: var(--dark);
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 10px;
            font-size: 0.95rem;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <header class="header">
        <img src="./logo.png" alt="Bank Sulselbar">
        <div>
            <h1>TNA Admin Dashboard</h1>
            <p>Training Need Analysis - Bank Sulselbar</p>
        </div>
    </header>
    
    <div class="container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon blue"><i class="fas fa-users"></i></div>
                <h3 id="statPegawai">0</h3>
                <p>Total Pegawai</p>
            </div>
            <div class="stat-card">
                <div class="icon green"><i class="fas fa-sitemap"></i></div>
                <h3 id="statJabatan">0</h3>
                <p>Total Jabatan</p>
            </div>
            <div class="stat-card">
                <div class="icon yellow"><i class="fas fa-book"></i></div>
                <h3 id="statModul">0</h3>
                <p>Total Modul</p>
            </div>
            <div class="stat-card">
                <div class="icon purple"><i class="fas fa-check-circle"></i></div>
                <h3 id="statSubmission">0</h3>
                <p>Submission TNA</p>
            </div>
        </div>
        
        <!-- Import Section -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-file-import"></i> Import Data dari Excel</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Urutan Import:</strong> 
                        1. Import Modul dulu → 2. Import Jabatan (Matrix) → 3. Import Pegawai
                    </div>
                </div>
                
                <!-- Import Tabs -->
                <div class="import-tabs">
                    <button class="import-tab active" data-type="modul" onclick="selectImportType('modul')">
                        <i class="fas fa-book"></i> Data Modul
                        <span class="badge">Kode_Modul.xlsx</span>
                    </button>
                    <button class="import-tab" data-type="jabatan" onclick="selectImportType('jabatan')">
                        <i class="fas fa-sitemap"></i> Data Jabatan + Matrix
                        <span class="badge">TNA_2026.xlsx</span>
                    </button>
                    <button class="import-tab" data-type="pegawai" onclick="selectImportType('pegawai')">
                        <i class="fas fa-users"></i> Data Pegawai
                        <span class="badge">Database_202511.xlsx</span>
                    </button>
                </div>
                
                <!-- Drop Zone -->
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileSelect(event)">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Drag & Drop file Excel di sini</h4>
                    <p>atau klik untuk memilih file</p>
                    <p style="margin-top: 0.5rem; font-size: 0.8rem;" id="expectedFile">File yang diharapkan: <strong>Kode_Modul.xlsx</strong></p>
                </div>
                
                <!-- File Info -->
                <div class="file-info" id="fileInfo">
                    <i class="fas fa-file-excel"></i>
                    <div class="details">
                        <h5 id="fileName">-</h5>
                        <p id="fileSize">-</p>
                    </div>
                    <button class="btn btn-danger" onclick="clearFile()" style="margin-left: auto;">
                        <i class="fas fa-times"></i> Hapus
                    </button>
                </div>
                
                <!-- Preview Section -->
                <div class="preview-section" id="previewSection">
                    <div class="preview-header">
                        <h4><i class="fas fa-table"></i> Preview Data (<span id="previewCount">0</span> rows)</h4>
                        <button class="btn btn-success" id="btnImport" onclick="importToFirebase()">
                            <i class="fas fa-upload"></i> Import ke Firebase
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table id="previewTable">
                            <thead id="previewHead"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Progress Section -->
                <div class="progress-section" id="progressSection">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p class="progress-text" id="progressText">Importing... 0%</p>
                </div>
            </div>
        </div>
        
        <!-- Data View Section -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-database"></i> Data di Firebase</h2>
                <button class="btn btn-primary" onclick="loadAllData()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showDataTab('pegawai')">
                        <i class="fas fa-users"></i> Pegawai (<span id="countPegawai">0</span>)
                    </button>
                    <button class="nav-tab" onclick="showDataTab('jabatan')">
                        <i class="fas fa-sitemap"></i> Jabatan (<span id="countJabatan">0</span>)
                    </button>
                    <button class="nav-tab" onclick="showDataTab('modul')">
                        <i class="fas fa-book"></i> Modul (<span id="countModul">0</span>)
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchData" placeholder="Cari data..." onkeyup="filterData()">
                </div>
                
                <!-- Data Tables -->
                <div id="dataPegawai" class="data-section active">
                    <div class="table-wrapper" style="max-height: 500px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>NPP</th>
                                    <th>Nama</th>
                                    <th>Jabatan</th>
                                    <th>Unit Kerja</th>
                                </tr>
                            </thead>
                            <tbody id="tablePegawai"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="dataJabatan" class="data-section">
                    <div class="table-wrapper" style="max-height: 500px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>No Outline</th>
                                    <th>Nama Jabatan</th>
                                    <th>Posisi</th>
                                    <th>Lokasi</th>
                                    <th>Modul Soft</th>
                                    <th>Modul Tech</th>
                                </tr>
                            </thead>
                            <tbody id="tableJabatan"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="dataModul" class="data-section">
                    <div class="table-wrapper" style="max-height: 500px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Kode</th>
                                    <th>Nama Modul</th>
                                    <th>Kategori</th>
                                    <th>Tingkatan</th>
                                    <th>Jenis</th>
                                </tr>
                            </thead>
                            <tbody id="tableModul"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyBiwuLzJ8lVBsP9UJ4w6HU2JevCF7K8NNk",
            authDomain: "tnahumancapital.firebaseapp.com",
            projectId: "tnahumancapital",
            storageBucket: "tnahumancapital.firebasestorage.app",
            messagingSenderId: "618822378444",
            appId: "1:618822378444:web:8cd59870928bd251613369"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ===== STATE =====
        let currentImportType = 'modul';
        let parsedData = [];
        let currentFile = null;
        
        // ===== TOAST =====
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        // ===== IMPORT TYPE SELECTION =====
        function selectImportType(type) {
            currentImportType = type;
            document.querySelectorAll('.import-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            const expectedFiles = {
                modul: 'Kode_Modul.xlsx',
                jabatan: 'TNA_2026.xlsx',
                pegawai: 'Database_202511.xlsx'
            };
            
            document.getElementById('expectedFile').innerHTML = 
                `File yang diharapkan: <strong>${expectedFiles[type]}</strong>`;
            
            clearFile();
        }
        
        // ===== FILE HANDLING =====
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }
        
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showToast('File harus berformat Excel (.xlsx atau .xls)', 'error');
                return;
            }
            
            currentFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('fileInfo').classList.add('show');
            
            // Parse Excel
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    switch(currentImportType) {
                        case 'modul':
                            parseModulFile(workbook);
                            break;
                        case 'jabatan':
                            parseJabatanFile(workbook);
                            break;
                        case 'pegawai':
                            parsePegawaiFile(workbook);
                            break;
                    }
                } catch (error) {
                    console.error('Parse error:', error);
                    showToast('Gagal membaca file Excel: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function clearFile() {
            currentFile = null;
            parsedData = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('previewSection').classList.remove('show');
            document.getElementById('progressSection').classList.remove('show');
        }
        
        // ===== PARSE MODUL (Kode_Modul.xlsx) =====
        function parseModulFile(workbook) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            parsedData = [];
            
            // Header di row 1 (index 1): KOMPETENSI, Kode Modul, NAMA MODUL, TUJUAN, TINGKATAN
            for (let i = 2; i < raw.length; i++) {
                const row = raw[i];
                if (!row || !row[1]) continue;
                
                const kodeRaw = String(row[1]).trim();
                if (!kodeRaw || kodeRaw === 'Kode Modul') continue;
                
                // Extract short code
                let kode = kodeRaw;
                let jenis = 'technical';
                
                if (kodeRaw.startsWith('CCLM') || kodeRaw.startsWith('DCLM')) {
                    jenis = 'soft';
                } else {
                    // Extract REN-01 from TCLM-xxx (REN)-01
                    const match = kodeRaw.match(/\(([A-Z]+)\)-(\d+)$/);
                    if (match) {
                        kode = `${match[1]}-${match[2]}`;
                    }
                }
                
                parsedData.push({
                    kode: kode,
                    kode_full: kodeRaw,
                    nama: String(row[2] || '').trim(),
                    kategori: String(row[0] || '').trim(),
                    tingkatan: String(row[4] || 'Basic').trim(),
                    tujuan: String(row[3] || '').trim().substring(0, 500),
                    jenis: jenis
                });
            }
            
            showPreview(['Kode', 'Nama', 'Kategori', 'Tingkatan', 'Jenis'], 
                parsedData.map(m => [m.kode, m.nama.substring(0, 50), m.kategori.substring(0, 30), m.tingkatan, m.jenis]));
            
            showToast(`${parsedData.length} modul berhasil di-parse`, 'success');
        }
        
        // ===== PARSE JABATAN (TNA_2026.xlsx) =====
        function parseJabatanFile(workbook) {
            parsedData = [];
            const jabatanMap = {};
            
            // Sheet 1: Jabatan vs ModulSoft
            const sheetSoft = workbook.Sheets['Jabatan vs ModulSoft'];
            if (sheetSoft) {
                const rawSoft = XLSX.utils.sheet_to_json(sheetSoft, { header: 1 });
                
                // Get modul codes from header row 1
                const modulCodesSoft = [];
                for (let col = 8; col < rawSoft[1]?.length; col++) {
                    const val = rawSoft[1][col];
                    if (val) {
                        const code = String(val).split('\n')[0].trim();
                        modulCodesSoft.push({ col, code });
                    }
                }
                
                // Parse jabatan data starting from row 8
                for (let i = 8; i < rawSoft.length; i++) {
                    const row = rawSoft[i];
                    const noOutline = row[2] ? String(row[2]).trim() : '';
                    const namaJabatan = row[3] ? String(row[3]).trim() : '';
                    
                    if (!noOutline || noOutline === 'nan') continue;
                    
                    // Sanitize jabId - remove problematic characters
                    const jabId = noOutline
                        .replace(/\./g, '-')
                        .replace(/\//g, '-')
                        .replace(/\\/g, '-')
                        .replace(/\s+/g, '_');
                    
                    // Collect modul wajib (X) and opsional (XO)
                    const softWajib = [];
                    const softOpsional = [];
                    
                    modulCodesSoft.forEach(m => {
                        const val = row[m.col] ? String(row[m.col]).trim().toUpperCase() : '';
                        if (val === 'X') softWajib.push(m.code);
                        else if (val === 'XO') softOpsional.push(m.code);
                    });
                    
                    jabatanMap[jabId] = {
                        no_outline: noOutline,
                        nama_jabatan: namaJabatan,
                        posisi: row[4] ? String(row[4]).trim() : '',
                        lokasi: row[5] ? String(row[5]).trim() : '',
                        level: row[6] ? String(row[6]).trim() : '',
                        modul_soft_wajib: softWajib,
                        modul_soft_opsional: softOpsional,
                        modul_tech_wajib: [],
                        modul_tech_opsional: []
                    };
                }
            }
            
            // Sheet 2: Jabatan vs ModulTech
            const sheetTech = workbook.Sheets['Jabatan vs ModulTech'];
            if (sheetTech) {
                const rawTech = XLSX.utils.sheet_to_json(sheetTech, { header: 1 });
                
                // Get modul codes from header row 2
                const modulCodesTech = [];
                for (let col = 6; col < rawTech[2]?.length; col++) {
                    const val = rawTech[2][col];
                    if (val) {
                        const codeRaw = String(val).split('\n')[0].trim();
                        const match = codeRaw.match(/TCLM-([A-Z]+)-(\d+)/);
                        const code = match ? `${match[1]}-${match[2]}` : codeRaw;
                        modulCodesTech.push({ col, code });
                    }
                }
                
                // Parse tech modul for existing jabatan
                for (let i = 10; i < rawTech.length; i++) {
                    const row = rawTech[i];
                    const namaJabatan = row[1] ? String(row[1]).trim() : '';
                    
                    if (!namaJabatan) continue;
                    
                    // Find matching jabatan by name
                    let matchedId = null;
                    for (const [id, jab] of Object.entries(jabatanMap)) {
                        if (jab.nama_jabatan === namaJabatan) {
                            matchedId = id;
                            break;
                        }
                    }
                    
                    if (!matchedId) continue;
                    
                    // Collect tech modul
                    modulCodesTech.forEach(m => {
                        const val = row[m.col] ? String(row[m.col]).trim().toUpperCase() : '';
                        if (val === 'X') jabatanMap[matchedId].modul_tech_wajib.push(m.code);
                        else if (val === 'XO') jabatanMap[matchedId].modul_tech_opsional.push(m.code);
                    });
                }
            }
            
            parsedData = Object.values(jabatanMap);
            
            showPreview(['No Outline', 'Nama Jabatan', 'Posisi', 'Soft', 'Tech'], 
                parsedData.slice(0, 100).map(j => [
                    j.no_outline, 
                    j.nama_jabatan.substring(0, 40), 
                    j.posisi.substring(0, 15),
                    (j.modul_soft_wajib?.length || 0) + (j.modul_soft_opsional?.length || 0),
                    (j.modul_tech_wajib?.length || 0) + (j.modul_tech_opsional?.length || 0)
                ]));
            
            showToast(`${parsedData.length} jabatan berhasil di-parse`, 'success');
        }
        
        // ===== PARSE PEGAWAI (Database_202511.xlsx) =====
        function parsePegawaiFile(workbook) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            parsedData = [];
            
            // Data starts from row 7 (index 7)
            // Columns: 2=No, 3=Nama, 5=NPP, 10=Jabatan, 12=Unit Kerja
            for (let i = 7; i < raw.length; i++) {
                const row = raw[i];
                const nama = row[3] ? String(row[3]).trim() : '';
                const nppRaw = row[5];
                const jabatan = row[10] ? String(row[10]).trim() : '';
                const unit = row[12] ? String(row[12]).trim() : '';
                
                if (!nama || !nppRaw) continue;
                
                // Clean NPP: "80 05" -> "8005"
                const npp = String(nppRaw).replace(/\s/g, '').replace('.0', '');
                
                if (!npp) continue;
                
                parsedData.push({
                    npp: npp,
                    nama: nama,
                    jabatan: jabatan,
                    unit_kerja: unit
                });
            }
            
            showPreview(['NPP', 'Nama', 'Jabatan', 'Unit Kerja'], 
                parsedData.slice(0, 100).map(p => [p.npp, p.nama, p.jabatan.substring(0, 35), p.unit_kerja]));
            
            showToast(`${parsedData.length} pegawai berhasil di-parse`, 'success');
        }
        
        // ===== SHOW PREVIEW =====
        function showPreview(headers, rows) {
            const thead = document.getElementById('previewHead');
            const tbody = document.getElementById('previewBody');
            
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(row => 
                '<tr>' + row.map(cell => `<td>${cell || '-'}</td>`).join('') + '</tr>'
            ).join('');
            
            document.getElementById('previewCount').textContent = parsedData.length;
            document.getElementById('previewSection').classList.add('show');
        }
        
        // ===== IMPORT TO FIREBASE =====
        async function importToFirebase() {
            if (parsedData.length === 0) {
                showToast('Tidak ada data untuk diimport', 'error');
                return;
            }
            
            const btn = document.getElementById('btnImport');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
            
            document.getElementById('progressSection').classList.add('show');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            try {
                const collection = currentImportType === 'jabatan' ? 'jabatan' : currentImportType;
                const total = parsedData.length;
                let uploaded = 0;
                const batchSize = 400;
                
                for (let i = 0; i < total; i += batchSize) {
                    const batch = db.batch();
                    const chunk = parsedData.slice(i, Math.min(i + batchSize, total));
                    
                    chunk.forEach(item => {
                        let docId;
                        let data = { ...item };
                        
                        switch(currentImportType) {
                            case 'modul':
                                docId = item.kode;
                                data.created_at = firebase.firestore.FieldValue.serverTimestamp();
                                break;
                            case 'jabatan':
                                // Sanitize: use no_outline, replace problematic characters
                                docId = (item.no_outline || 'unknown')
                                    .replace(/\./g, '-')
                                    .replace(/\//g, '-')
                                    .replace(/\\/g, '-')
                                    .replace(/\s+/g, '_')
                                    .substring(0, 100);
                                data.created_at = firebase.firestore.FieldValue.serverTimestamp();
                                break;
                            case 'pegawai':
                                docId = item.npp;
                                data.created_at = firebase.firestore.FieldValue.serverTimestamp();
                                break;
                        }
                        
                        // Final safety check - remove any remaining /
                        docId = String(docId).replace(/\//g, '-');
                        
                        if (!docId || docId === 'unknown') {
                            console.log('Skipping invalid item:', item);
                            return;
                        }
                        
                        const ref = db.collection(collection).doc(docId);
                        batch.set(ref, data, { merge: true });
                    });
                    
                    await batch.commit();
                    uploaded += chunk.length;
                    
                    const percent = Math.round((uploaded / total) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = `Importing... ${uploaded}/${total} (${percent}%)`;
                }
                
                progressText.textContent = `Selesai! ${total} data berhasil diimport.`;
                showToast(`${total} ${currentImportType} berhasil diimport ke Firebase!`, 'success');
                
                // Refresh data view
                loadAllData();
                
            } catch (error) {
                console.error('Import error:', error);
                showToast('Gagal import: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload"></i> Import ke Firebase';
            }
        }
        
        // ===== LOAD DATA FROM FIREBASE =====
        async function loadAllData() {
            try {
                // Load Pegawai
                const pegawaiSnap = await db.collection('pegawai').limit(500).get();
                const pegawaiData = [];
                pegawaiSnap.forEach(doc => pegawaiData.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('statPegawai').textContent = pegawaiData.length;
                document.getElementById('countPegawai').textContent = pegawaiData.length;
                
                document.getElementById('tablePegawai').innerHTML = pegawaiData.map(p => `
                    <tr>
                        <td><strong>${p.npp}</strong></td>
                        <td>${p.nama}</td>
                        <td>${p.jabatan || '-'}</td>
                        <td>${p.unit_kerja || '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align:center;padding:2rem;">Belum ada data</td></tr>';
                
                // Load Jabatan
                const jabatanSnap = await db.collection('jabatan').limit(500).get();
                const jabatanData = [];
                jabatanSnap.forEach(doc => jabatanData.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('statJabatan').textContent = jabatanData.length;
                document.getElementById('countJabatan').textContent = jabatanData.length;
                
                document.getElementById('tableJabatan').innerHTML = jabatanData.map(j => `
                    <tr>
                        <td><strong>${j.no_outline}</strong></td>
                        <td>${j.nama_jabatan || '-'}</td>
                        <td>${j.posisi || '-'}</td>
                        <td>${j.lokasi || '-'}</td>
                        <td>${(j.modul_soft_wajib?.length || 0) + (j.modul_soft_opsional?.length || 0)}</td>
                        <td>${(j.modul_tech_wajib?.length || 0) + (j.modul_tech_opsional?.length || 0)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align:center;padding:2rem;">Belum ada data</td></tr>';
                
                // Load Modul
                const modulSnap = await db.collection('modul').limit(500).get();
                const modulData = [];
                modulSnap.forEach(doc => modulData.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('statModul').textContent = modulData.length;
                document.getElementById('countModul').textContent = modulData.length;
                
                document.getElementById('tableModul').innerHTML = modulData.map(m => `
                    <tr>
                        <td><strong>${m.kode}</strong></td>
                        <td>${m.nama || '-'}</td>
                        <td>${m.kategori || '-'}</td>
                        <td><span class="pill pill-${m.tingkatan === 'Basic' ? 'info' : m.tingkatan === 'Intermediate' ? 'warning' : 'success'}">${m.tingkatan}</span></td>
                        <td><span class="pill pill-${m.jenis === 'soft' ? 'info' : 'success'}">${m.jenis}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem;">Belum ada data</td></tr>';
                
            } catch (error) {
                console.error('Load error:', error);
                showToast('Gagal memuat data: ' + error.message, 'error');
            }
        }
        
        // ===== DATA TAB NAVIGATION =====
        function showDataTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.data-section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('data' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }
        
        function filterData() {
            const query = document.getElementById('searchData').value.toLowerCase();
            document.querySelectorAll('.data-section.active tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }
        
        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });
    </script>
</body>
</html>
